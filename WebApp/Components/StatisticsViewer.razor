@using WebApp.Models

<div class="card shadow-sm border-0 h-100 d-flex flex-column">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <span>
            <i class="bi bi-bar-chart-line-fill"></i> Estadísticas de la temporada 2025
        </span>
    </div>
    <div class="card-body d-flex flex-column flex-grow-1" style="height: 30vh; overflow-y: auto;">
        <div class="row g-4">
            <div class="col-6">
                <i>Frecuencia de letra 'A' y conteo de palabras en nombre</i>
                <div class="table-responsive flex-grow-1 overflow-auto">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th scope="col">FUTBOLISTA</th>
                                <th scope="col">REPETICIONES 'A'</th>
                                <th scope="col">NÚMERO PALABRAS</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (PlayerNameStatisticsRecords == null || !PlayerNameStatisticsRecords.Any())
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        No hay datos de jugadores disponibles.
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var record in PlayerNameStatisticsRecords!)
                                {
                                    <tr>
                                        <td>@record.PlayerName</td>
                                        <td>@record.LetterACount</td>
                                        <td>@record.WordsCount</td>
                                    </tr>
                                }
                            }

                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-6">
                <i>Equipos fundados entre 1900 y 1950</i>
                <div class="table-responsive flex-grow-1 overflow-auto">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th scope="col">CÓDIGO EQUIPO</th>
                                <th scope="col">NOMBRE EQUIPO</th>
                                <th scope="col">FUNDACIÓN</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (TeamFoundationsStatisticsRecords == null || !TeamFoundationsStatisticsRecords.Any())
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        No hay equipos fundados entre 1900 y 1950.
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var record in TeamFoundationsStatisticsRecords!)
                                {
                                    <tr>
                                        <td>@record.TeamCode</td>
                                        <td>@record.TeamName</td>
                                        <td>@record.FoundationYear</td>
                                    </tr>
                                }
                            }

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-6">
                <i>Goleadores de la categroría A</i>
                <div class="table-responsive flex-grow-1 overflow-auto">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th scope="col">CÓDIGO EQUIPO</th>
                                <th scope="col">NOMBRE JUGADOR</th>
                                <th scope="col">GOLES</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (PlayersMaximumGoalsStatisticsRecords == null || !PlayersMaximumGoalsStatisticsRecords.Any())
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        No hay goleadores registrados.
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var record in PlayersMaximumGoalsStatisticsRecords!)
                                {
                                    <tr>
                                        <td>@record.TeamCode</td>
                                        <td>@record.PlayerName</td>
                                        <td>@record.GoalsCount</td>
                                    </tr>
                                }
                            }

                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-6">
                <i>Arqueros lesionados de la categoría C</i>
                <div class="table-responsive flex-grow-1 overflow-auto">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th scope="col">CÓDIGO EQUIPO</th>
                                <th scope="col">NOMBRE ARQUERO</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (InjuredGoalkeepersStatisticsRecords == null || !InjuredGoalkeepersStatisticsRecords.Any())
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        No hay arqueros lesionados de la categoría C.
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var record in InjuredGoalkeepersStatisticsRecords!)
                                {
                                    <tr>
                                        <td>@record.TeamCode</td>
                                        <td>@record.GoalkeeperName</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public List<Player>? OriginalPlayersList { get; set; }
    [Parameter] public List<Team>? OriginalTeamsList { get; set; }
    public List<PlayerNameStatistics>? PlayerNameStatisticsRecords { get; set; }
    public List<TeamFoundationsStatistics>? TeamFoundationsStatisticsRecords { get; set; }
    public List<PlayersMaximumGoalsStatistics>? PlayersMaximumGoalsStatisticsRecords { get; set; }
    public List<InjuredGoalkeepersStatistics>? InjuredGoalkeepersStatisticsRecords { get; set; }

    public record PlayerNameStatistics(string PlayerName, int LetterACount, int WordsCount);
    public record TeamFoundationsStatistics(string TeamCode, string TeamName, long FoundationYear);
    public record PlayersMaximumGoalsStatistics(string TeamCode, string PlayerName, int GoalsCount);
    public record InjuredGoalkeepersStatistics(string TeamCode, string GoalkeeperName);
    protected override void OnParametersSet()
    {
        if (OriginalPlayersList != null && OriginalTeamsList != null)
        {
            PlayerNameStatisticsRecords = ComputePlayerNameStatistics();
            TeamFoundationsStatisticsRecords = ComputeTeamFoundationsStatistics();
            PlayersMaximumGoalsStatisticsRecords = ComputePlayersMaximumGoalsStatistics();
            InjuredGoalkeepersStatisticsRecords = ComputeInjuredGoalkeepersStatistics();
        }
    }
    private List<PlayerNameStatistics> ComputePlayerNameStatistics()
    {
        return OriginalPlayersList!
        .Select(p => new PlayerNameStatistics(
        p.Name,
        p.Name.Count(c => char.ToLower(c) == 'a'),
        p.Name.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length
        )).ToList();
    }

    private List<TeamFoundationsStatistics> ComputeTeamFoundationsStatistics()
    {
        return OriginalTeamsList!
        .Where(t => t.FoundationDate >= 1900 && t.FoundationDate <= 1950)
        .Select(t => new TeamFoundationsStatistics(
        t.TeamCode,
        t.Name,
        t.FoundationDate
        )).ToList();
    }

    private List<PlayersMaximumGoalsStatistics> ComputePlayersMaximumGoalsStatistics()
    {
        return OriginalPlayersList!
            .Where(p => p.GoalsScored > 10)
            .Select(player => new
            {
                Player = player,
                Team = OriginalTeamsList!.FirstOrDefault(t => t.Id == player.TeamId)
            })
            .Where(x => x.Team?.Category == 0)
            .OrderByDescending(x => x.Player.GoalsScored)
            .Select(x => new PlayersMaximumGoalsStatistics(
                x.Team!.TeamCode,
                x.Player.Name,
                x.Player.GoalsScored
            )).ToList();
    }

    private List<InjuredGoalkeepersStatistics> ComputeInjuredGoalkeepersStatistics()
    {
        return OriginalPlayersList!
            .Where(p => p.Position == 0 && p.IsInjured)
            .Select(player => new
            {
                Player = player,
                Team = OriginalTeamsList!.FirstOrDefault(t => t.Id == player.TeamId)
            })
            .Where(x => x.Team?.Category == 2)
            .Select(x => new InjuredGoalkeepersStatistics(
                x.Team!.TeamCode,
                x.Player.Name
            )).ToList();
    }

}