@using WebApp.Models
@using System.ComponentModel.DataAnnotations

@if (isVisible)
{
    <div class="modal-backdrop fade show"></div>

    <div class="modal fade show d-block" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content border-0 shadow-lg">
                
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="bi @(IsEditMode ? "bi-pencil-square" : "bi-plus-circle") me-2"></i>
                        @(IsEditMode ? "Editar Equipo" : "Registrar Nuevo Equipo")
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
                </div>

                <div class="modal-body p-4">
                    <EditForm Model="teamModel" OnValidSubmit="SaveChanges">
                        <DataAnnotationsValidator />
                        
                        <ValidationSummary class="alert alert-danger mb-3" />

                        <div class="row g-3">
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-secondary small text-uppercase">
                                    <i class="bi bi-upc-scan me-1"></i> Código (3 Letras)
                                </label>
                                <InputText class="form-control" @bind-Value="teamModel.TeamCode" maxlength="3" 
                                           style="text-transform:uppercase" placeholder="Ej: BAR" />
                                <ValidationMessage For="@(() => teamModel.TeamCode)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold text-secondary small text-uppercase">
                                    <i class="bi bi-tag-fill me-1"></i> Nombre del Equipo
                                </label>
                                <InputText class="form-control" @bind-Value="teamModel.Name" placeholder="Ej: Barcelona SC" />
                                <ValidationMessage For="@(() => teamModel.Name)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold text-secondary small text-uppercase">
                                    <i class="bi bi-geo-alt-fill me-1"></i> País de Origen
                                </label>
                                <InputText class="form-control" @bind-Value="teamModel.Country" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold text-secondary small text-uppercase">
                                    <i class="bi bi-calendar-event me-1"></i> Año Fundación
                                </label>
                                <InputNumber class="form-control" @bind-Value="teamModel.FoundationDate" />
                                <ValidationMessage For="@(() => teamModel.FoundationDate)" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold text-secondary small text-uppercase">
                                    <i class="bi bi-trophy-fill me-1"></i> Categoría
                                </label>
                                <InputSelect class="form-select" @bind-Value="teamModel.Category">
                                    <option value="0">Categoría A (Profesional)</option>
                                    <option value="1">Categoría B (Ascenso)</option>
                                    <option value="2">Categoría C (Amateur)</option>
                                </InputSelect>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold text-secondary small text-uppercase">
                                    <i class="bi bi-cash-stack me-1"></i> Presupuesto
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <InputNumber class="form-control" @bind-Value="teamModel.Budget" />
                                </div>
                                <ValidationMessage For="@(() => teamModel.Budget)" />
                            </div>

                        </div>

                        <div class="mt-4 d-flex justify-content-end gap-2 border-top pt-3">
                            <button type="button" class="btn btn-secondary" @onclick="CloseModal">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-success px-4">
                                <i class="bi bi-save me-2"></i> Guardar Datos
                            </button>
                        </div>

                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool isVisible { get; set; }
    [Parameter] public Team? teamToEdit { get; set; }
    [Parameter] public EventCallback onClose { get; set; }
    [Parameter] public EventCallback<Team> OnSave { get; set; }

    private Team teamModel = new();
    private bool IsEditMode => teamToEdit != null && teamToEdit.Id > 0;

    protected override void OnParametersSet()
    {
        if (isVisible)
        {
            if (teamToEdit != null)
            {
                teamModel = new Team
                {
                    Id = teamToEdit.Id,
                    TeamCode = teamToEdit.TeamCode,
                    Name = teamToEdit.Name,
                    Country = teamToEdit.Country,
                    Category = teamToEdit.Category,
                    FoundationDate = teamToEdit.FoundationDate,
                    Budget = teamToEdit.Budget
                };
            }
            else
            {
                teamModel = new Team { FoundationDate = 2025 };
            }
        }
    }

    private async Task CloseModal()
    {
        await onClose.InvokeAsync();
    }

    private async Task SaveChanges()
    {
        teamModel.TeamCode = teamModel.TeamCode?.ToUpper() ?? "";
        
        await OnSave.InvokeAsync(teamModel);
    }
}